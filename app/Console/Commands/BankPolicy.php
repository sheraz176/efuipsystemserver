<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Models\Subscription\CustomerSubscription;
use App\Models\Unsubscription\CustomerUnSubscription;
use App\Models\Refund\RefundedCustomer;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
class BankPolicy extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'bank:policy';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return int
     */
    public function handle()
    {
        DB::enableQueryLog();
        $pairs = [
          ['03702851779',2900],
['03347895345',2950],
['03132808530',2950],
['03015209287',2950],
['03063733340',1950],
['03203659604',1950],
['03219010348',1950],
['03216085762',2950],
['03214601676',1500],
['03296030310',1500],
['03241856980',1500],
['03023986711',2950],
['03230291939',1950],
['03233250917',1950],
['03005316958',1950],
['03012565356',1950],
['03092250223',1950],
['03288072851',1950],
['03226077080',1950],
['03236537106',2950],
['03037190412',1950],
['03313409069',1950],
['03252471669',1950],
['03290740907',2950],
['03085453962',2950],
['03013161656',1950],
['03167147074',1950],
['03042752260',1950],
['03217849033',2950],
['03217752574',1950],
['03004687783',1950],
['03280645655',2000],
['03293687486',2000],
['03137664826',2000],
['03091830198',2000],
['03035735502',2000],
['03054234530',2000],
['03096385215',2000],
['03064058347',2000],
['03040751467',2000],
['03027076125',2000],
['03243199854',2000],
['03274521240',2000],
['03246876216',2000],
['03060384855',2000],
['03081710202',2000],
['03032502780',2000],
['03298815274',2000],
['03079480425',2000],
['03017650627',2000],
['03255381051',2000],
['03083999087',2000],
['03040220651',2000],
['03216085762',2950],
['03033796515',2900],
['03035665878',2950],
['03264749028',2950],
['03092110062',2950],
['03236688399',2900],
['03277068780',2950],
['03003753056',2950],
['03082246479',2950],
['03052372150',2900],
['03282674781',2950],
['03034515774',2950],
['03358252767',2950],
['03296201687',2950],
['03324544831',2950],
['03039081680',2950],
['03011882400',2950],
['03352088811',2950],
['03061633526',2950],
['03027363515',2950],
['03256265083',2950],
['03070355391',2950],
['03212811246',2950],
['03284618665',2950],
['03094325700',2950],
['03023219123',2950],
['03370453286',2950],
['03004992860',2950],
['03252722041',2950],
['03061233410',2950],
['03006466785',2900],
['03261020296',2950],
['03019365417',2950],
['03035678146',2950],
['03266894138',2950],
['03034314675',2950],
['03351478591',2950],
['03021140998',2950],
['03334900835',2950],
['03172489145',2950],
['03030465075',2950],
['03073034532',2950],
['03345656450',2900],
['03088896942',2950],
['03241711311',2950],
['03023111623',2900],
['03037626317',2950],
['03377044346',2950],
['03245243916',2950],
['03264336011',2950],
['03243178463',2950],
['03206852088',2950],
['03023940029',2900],
['03057040918',2950],
['03024712941',2950],
['03017165314',2950],
['03046126800',2950],
['03020637371',2950],
['03231387885',2950],
['03213100150',2950],
['03294836639',2950],
['03257972176',2950],
['03098683193',2950],
['03064514171',2950],
['03007028247',2950],
['03026730047',2950],
['03378394561',2950],
['03006017654',2900],
['03081795616',2950],
['03264355950',2900],
['03004693847',2950],
['03230949895',2950],
['03216997782',2950],
['03027790728',2950],
['03074081862',2950],
['03201130251',2950],
['03009893142',2950],
['03166065300',2950],
['03037800488',2950],
['03034012806',2950],
['03338133256',2900],
['03064904628',2950],
['03283008520',2950],
['03258192181',2950],
['03235241355',2900],
['03269727425',2950],
['03036802109',2900],
['03044037817',2950],
['03288823994',2950],
['03054758155',2950],
['03253877625',2950],
['03044674097',2950],
['03263021206',2950],
['03080807964',2950],
['03706034960',2950],
['03024215012',2900],
['03027511211',2950],
['03012510891',2950],
['03000859467',2900],
['03229605751',2950],
['03275432635',2950],
['03021780836',2950],
['03423990455',2950],
['03015840938',2950],
['03423548213',2950],
['03013002891',2950],
['03237762380',2950],
['03087876296',2900],
['03218936912',2950],
['03457888187',2950],
['03217229638',2950],
['03361481572',2900],
['03042784980',2950],
['03292574594',2950],
['03015311090',2950],
['03064259784',2000],
['03076939650',2950],
['03236522428',2950],
['03023039261',2950],
['03097508767',2950],
['03276703352',2950],
['03002201095',2950],
['03340543966',2950],
['03101744635',2950],
['03075202406',2950],
['03136317110',2950],
['03045474745',2900],
['03213911250',2900],
['03107947550',2950],
['03217434438',2950],
['03034407117',2950],
['03020999495',2950],
['03200445349',2950],
['03083949078',2900],
['03062871446',2900],
['03218177337',2950],
['03086744273',2900],
['03044692325',2900],
['03279965198',2000],
['03023487385',2950],
['03168489453',2950],
['03032752697',2950],
['03245704374',2950],
['03024518367',2950],
['03348061680',2950],
['03223499782',2950],
['03032547761',2950],
['03072528533',2950],
['03027606828',2000],
['03027606828',2000],
['03068624294',2950],
['03071454064',1500],
['03367506851',1950],
['03202515507',2900],
['03040584429',2000],
['03054801961',1950],
['03281361246',2950],
['03299514065',2950],
['03066719530',1950],
['03048815783',2950],
['03180817061',2950],
['03011021691',2950],
['03280646101',2000],
['03086164005',2000],
['03072721632',2900],
['03017532975',2000],
['03405793440',1500],
['03041337971',1950],
['03285743177',1950],
['03292256840',1950],
['03207280672',1950],
['03059884042',1950],
['03043869520',1950],
['03202275876',1950],
['03014728614',1950],
['03261939832',1950],
['03276838173',2000],
['03061782441',2000],
['03209448904',2000],
['03032858379',1950],
['03277492152',2000],
['03235400548',2000],
['03315504092',2000],
['03051931957',2000],
['03058612904',1950],
['03116177457',2000],
['03076749788',1950],
['03094906224',1950],
['03025310909',2000],
['03032885207',2000],
['03263978207',2000],
['03015617710',2950],
['03316452040',2950],
['03217678821',2950],
['03200962100',2950],
['03269020729',1500],
['03242434985',1950],
['03070603885',1950],
['03241463895',1950],
['03014901914',1950],
['03207998769',1950],
['03023630680',1950],
['03055677463',1950],
['03095569701',2000],
['03092244362',2000],
['03091397681',2000],
['03075651439',1500],
['03075573518',1950],
['03227316401',1950],
['03055989309',1950],
['03201699852',1950],
['03161420725',1950],
['03009863900',1950],
['03051513468',1950],
['03098797267',1950],
['03057870120',1950],
['03094940911',1950],
['03000098385',1950],
['03082631978',1950],
['03263109725',1950],
['03246528864',1950],
['03082135708',1950],
['03004579451',1950],
['03356898110',1950],
['03238128699',1950],
['03272834553',1950],
['03281721312',1950],
['03094504864',1950],
['03002769595',2000],
['03054411215',2000],
['03471674382',2000],
['03082152285',2000],
['03230372275',2000],
['03274975839',2000],
['03214041823',2000],
['03057765983',2000],
['03002998296',2000],
['03227581966',1950],
['03282536173',1950],
['03232689405',2000],
['03013451880',2950],
['03204032790',2950],
['03008744190',2950],
['03415003236',2900],
['03075353709',2950],
['03074134793',2950],
['03072998326',2950],
['03061512131',2950],
['03003047506',2000],
['03094648464',1950],
['03267453329',1500],
['03391031121',1950],
['03122213872',1950],
['03273514235',1950],
['03076030748',1950],
['03062934731',1950],
['03071829607',1950],
['03205911904',1950],
['03036551049',1950],
['03440650601',1950],
['03047487519',1950],
['03266591025',2000],
['03147883247',2000],
['03263299136',2000],
['03052255854',2000],
['03261053365',2000],
['03023001587',1950],
['03262611697',1950],
['03094595036',1950],
['03273824574',1950],
['03096548769',1500],
['03278070654',1950],
['03425993725',1950],
['03007151199',1950],
['03004661746',1950],
['03206910975',2000],
['03227004975',1950],
['03027347308',2000],
['03090616613',1950],
['03284005838',1950],
['03246796416',1950],
['03242730440',1950],
['03216118121',1950],
['03248637752',1950],
['03239299087',2000],
['03005559958',1950],
['03013621820',2950],
['03290136431',1950],
['03090869539',2000],
['03056319337',2950],
['03091632632',2950],
['03272885524',2950],
['03056621993',2950],
['03020443128',2950],
['03123541444',2950],
['03000829791',2000],
['03249325096',1950],
['03232972637',1950],
['03057566223',2000],
['03134559852',2000],
['03228236785',1950],
['03148433799',1950],
['03035084405',2000],
['03244871310',1950],
['03081183270',2000],
['03320005994',2000],
['03267252105',1950],
['03284069980',2000],
['03267005743',1950],
['03057566223',1500],
['03024206532',2900],
['03273185878',1500],
['03084791136',1950],
['03217282385',1950],
['03202010976',1950],
['03232307082',1950],
['03213284194',1950],
['03285918173',1950],
['03090992704',1950],
['03218848657',1950],
['03043419477',1950],
['03084584235',1950],
['03222809748',1950],
['03012911173',2950],
['03231952717',3900],
['03017988967',2900],
['03039083946',2950],
['03096339086',2950],
['03248257119',2950],
['03214122333',1950],
['03227272253',2950],
['03002466020',2950],
['03056398593',2950],
['03282300585',1950],
['03046652215',2950],
['03282721824',2950],
['03218735410',2950],
['03498271881',2000],
['03063501364',2000],
['03084226657',2000],
['03262352112',2000],
['03014136216',2000],
['03056887471',1500],
['03200330934',1500],
['03021594424',1500],
['03034271124',2900],
['03267481719',2900],
['03008101245',1950],
['03091530793',1950],
['03020740496',1950],
['03094377707',1950],
['03004585998',1950],
['03093490064',1950],
['03234433917',1950],
['03058601652',2950],
['03246101533',2950],
['03323720907',1950],
['03366133529',1950],
['03236531686',1950],
['03006412392',1950],
['03291631683',1950],
['03237413106',1950],
['03084424750',1950],
['03250425088',1950],
['03277719366',1950],
['03282450971',1950],
['03324380154',1950],
['03490542081',1950],
['03245678156',1950],
['03027701438',1950],
['03007855440',1950],
['03443919016',1950],
['03264473884',1950],
['03249151562',2000],
['03095983413',2000],
['03044760121',2000],
['03017942538',2000],
['03061001793',2000],
['03062570506',2000],
['03253924584',2000],
['03020124069',2000],
['03114362729',2000],
['03016005188',2000],
['03084957864',2000],
['03262571746',1950],
['03009676742',2950],
['03066546574',2950],
['03097193049',2950],
['03261267313',2950],
['03270186230',2950],
['03420216256',2950],
['03320450046',1950],
['03253851006',2950],
['03450216805',2950],
['03051731345',2000],
['03284191099',2950],
['03078562344',2900],
['03253767803',2900],
['03704368985',1500],
['03071330003',1950],
['03216297803',1950],
['03078562344',2950],
['03286170116',1950],
['03413128122',1950],
['03253767803',1950],
['03499600879',1950],
['03090144132',2950],
['03288021695',1950],
['03281845039',1950],
['03286899746',1950],
['03241710923',2950],
['03710082376',1950],
['03312578242',2950],
['03003669182',2000],
['03078562344',2000],
['03247264058',2000],
['03272969614',2000],
['03221063036',1950],
['03053072472',2000],
['03363818261',2000],
['03284072768',2000],
['03248812446',2000],
['03252973788',1950],
['03286782432',2000],
['03048564902',2950],
['03068011042',2950],
['03082670945',2950],
['03277412394',2000],
['03236408540',700],
['03084913028',1950],
['03254500531',1950],
['03015612217',2000],
['03266717580',2000],
['03007007231',2000],
['03251045785',2000],
['03088804912',2000],
['03247373780',2950],
['03240702500',2950],
['03099115635',2950],
['03009163135',2950],
['03046573257',2950],
['03246742474',2950],
['03251045785',2950],
['03006811550',2950],
['03275395958',2000],
['03281971271',2900],
['03705520213',1500],
['03017493389',2900],
['03088028068',1950],
['03047379168',1950],
['03029620576',1950],
['03010943207',1950],
['03082768919',1950],
['03252974676',1950],
['03094815182',1950],
['03077995209',1950],
['03076318358',1950],
['03222868100',2950],
['03455531673',1950],
['03009162825',2000],
['03244855613',2000],
['03224100405',1500],
['03397872005',1950],
['03097792566',1950],
['03219348088',1950],
['03090978490',1950],
['03473565364',1950],
['03009462605',2000],
['03290848585',2000],
['03014037589',2000],
['03061274031',2950],
['03012994791',299],
['03047385274',2000],
['03042310600',2000],
['03212569772',2000],
['03065219330',2000],
['03236226972',2000],
['03281278479',2950],
['03024001842',2000],
['03024408103',2950],
['03004771860',2000],
['03008014535',2000],
['03033634403',2000],
['03244129697',1950],
['03096019081',2000],
['03012579939',2950],
['03208260467',1950],
['03014378248',1950],
['03364564289',1500],
['03225273486',1950],
['03066263863',2000],
['03244221420',2000],
['03301549331',2950],
['03096394416',2950],
['03054406812',2950],
['03092857031',2000],
['03172535616',2000],
['03079325027',2900],
['03289021268',2000],
['03245358850',1950],
['03207941104',1950],
['03040453319',1500],
['03012828066',2950],
['03015993585',1950],
['03164916290',2000],
['03015827390',2950],
['03230173901',2000],
['03013144787',2000],
['03047338680',1950],
['03022189256',2000],
['03299231393',1950],
['03070878145',2950],
['03021844065',1950],
['03073216203',2950],
['03019830379',2950],
['03294454429',2950],
['03232784700',1950],
['03296101859',1950],
['03052742517',2000],
['03054417763',2000],
['03004643516',2000],
['03554386922',2000],
['03212452440',2000],
['03037811785',2000],
['03030535471',2950],
['03218561631',2950],
['03044157055',2950],
['03042409039',2950],
['03069736750',2950],
['03067938524',1950],
['03007949070',2000],
['03283462168',2900],
['03007509934',1500],
['03247896577',1950],
['03257964535',2950],
['03293398513',2000],
['03082527134',1950],
['03064646732',1500],
['03221685766',1950],
['03242571460',1950],
['03287691230',1950],
['03045042835',1950],
['03254319948',1950],
['03084070982',1950],
['03219419084',1950],
['03356424940',1950],
['03032412832',1950],
['03254482925',1950],
['03013190982',2000],
['03036782599',2000],
['03392427026',2000],
['03305509577',2900],
['03204327661',2900],
['03057564992',2950],
['03032945958',2950],
['03096850070',2950],
['03227277076',2950],
['03048588134',2950],
['03258204526',2950],
['03365085539',2950],
['03239520173',2950],
['03012324767',2950],
['03057295930',299],
['03234517407',2000],
['03021649625',1950],
['03038051920',2000],
['03067025597',2900],
['03003166130',2950],
['03458952895',2900],
['03102781320',2000],
['03102781320',2950],
['03004550671',200],
['03058199230',2950],
['03335119710',2900],
['03236625269',1950],
['03206755683',1950],
['03242370711',1950],
['03051925170',2000],
['03004757367',2900],
['03023330334',1500],
['03024201965',1500],
['03039935419',1500],
['03054126406',1500],
['03055270179',2900],
['03057584433',1500],
['03058581313',1500],
['03068148917',2900],
['03073106941',2900],
['03077916538',2900],
['03078674559',2900],
['03092911202',2900],
['03094938604',1500],
['03099810961',2900],
['03204832305',2900],
['03212996245',1500],
['03231664465',2900],
['03238496091',2900],
['03254261442',2900],
['03255837483',2900],
['03256196005',1500],
['03256956408',1500],
['03259295729',1500],
['03261528015',2900],
['03263399684',2900],
['03270299369',2900],
['03451318205',2950],
['03457883356',2900],
['03458952895',2900],
['03007536865',2900],
['03116530516',1500],
['03131441718',2900],
['03285711324',2900],
['03025358789',2900],
['03180724358',2900],
['03023827994',2950],
['03004542432',1950],
['03006909399',2950],
['03012099373',2950],
['03016262949',2950],
['03017974625',2950],
['03020563710',2950],
['03020694770',1950],
['03021574562',1950],
['03024330037',1950],
['03027014054',2950],
['03029505780',1950],
['03032653193',2950],
['03034582617',1950],
['03035582032',2950],
['03036789370',2950],
['03036982314',2950],
['03037037917',1950],
['03037415908',1950],
['03038105118',2950],
['03042444875',2950],
['03043702486',2950],
['03051367215',1950],
['03052942591',1950],
['03053441418',2950],
['03054450725',2950],
['03056559829',1950],
['03056953123',2950],
['03061701419',1950],
['03064703856',1950],
['03069794167',1950],
['03072544339',1950],
['03074080400',1950],
['03074199410',2950],
['03076115550',1950],
['03076550154',1950],
['03077434919',2950],
['03080141782',2950],
['03088824483',1950],
['03090255164',1950],
['03093743990',2950],
['03094255438',2950],
['03096776518',1950],
['03097768552',2950],
['03099130180',1950],
['03140932798',2950],
['03144651958',1950],
['03149970917',1950],
['03152301306',1950],
['03196671707',1950],
['03207172217',1950],
['03207745507',1950],
['03211213090',1950],
['03214601676',1950],
['03214608530',1950],
['03214625447',1950],
['03217179257',1950],
['03217602188',2950],
['03218509300',1950],
['03219975732',1950],
['03224488221',2950],
['03225546426',2950],
['03226017978',2950],
['03231843079',1950],
['03233340739',1950],
['03234411261',1950],
['03238174696',1950],
['03238901231',2950],
['03239009801',1950],
['03246372353',2950],
['03247192570',1950],
['03247764921',2950],
['03247791870',2950],
['03254594795',2950],
['03255923490',1950],
['03259381549',1950],
['03267254351',2950],
['03267338908',2950],
['03267613145',2950],
['03267744528',2950],
['03267907376',2950],
['03270107602',1950],
['03281443320',2950],
['03281929816',2950],
['03286481880',2950],
['03288049022',1950],
['03290512576',1950],
['03291901395',2950],
['03293510036',2950],
['03294634951',1950],
['03294700124',1950],
['03296044143',2950],
['03299621882',1950],
['03312961840',2950],
['03323022093',1950],
['03341215280',2950],
['03427283156',1950],
['03473043012',1950],
['03041295187',1950],
['03094040399',1950],
['03014546803',1950],
['03077556941',1950],
['03155245484',1950],
['03053528307',2950],
['03224812308',2950],
['03218231781',2950],
['03283012428',2950],
['03082678194',1950],
['03074878877',1950],
['03258950063',1950],
['03262157453',1950],
['03251310713',1950],
['03021173082',1950],
['03217667378',1950],
['03214306212',1950],
['03027587693',1950],
['03434346673',1950],
['03219469074',1950],
['03486900047',1950],
['03260874965',1950],
['03064020494',2950],
['03241065007',2950],
['03065758211',2950],
['03087952147',2950],
['03012864047',2950],
['03329627006',2950],
['03030306828',2950],
['03283232408',1950],
['03269725913',2950],
['03040918254',2950],
['03364371639',2950],
['03203788620',2950],
['03117314586',2950],
['03235264542',1950],
['03288064881',1950],
['03096484860',1950],
['03225314616',2950],
['03220175661',1950],
['03270348214',2950],
['03096657620',2950],
['03053947332',2950],
['03014171527',2950],
['03014622789',1950],
['03030726221',2950],
['03244759026',1950],
['03081933715',1950],
['03463681124',1950],
['03294622319',2950],
['03007017038',2000],
['03018018925',2000],
['03018970268',2000],
['03027007785',2000],
['03034073962',2000],
['03044175408',2000],
['03048053047',2000],
['03054433214',2000],
['03057762267',2000],
['03072103313',2000],
['03074465728',2000],
['03089850131',2000],
['03093726167',2000],
['03102136113',2000],
['03128286336',2000],
['03134801661',2000],
['03164134179',2000],
['03194479378',2000],
['03211474189',2000],
['03215127670',2000],
['03216517022',2000],
['03220192762',2000],
['03221805373',2000],
['03222770788',2000],
['03226213489',2000],
['03227599817',2000],
['03227741528',2000],
['03234344370',2000],
['03252200240',2000],
['03262738223',2000],
['03287692803',2000],
['03289715028',2000],
['03291715951',2000],
['03295807458',2000],
['03296656061',2000],
['03296686818',2000],
['03298126950',2000],
['03323329779',2000],
['03328843316',2000],
['03345078807',2000],
['03366186242',2000],
['03366433158',2000],
['03055760511',2000],
['03004149758',2000],
['03272092589',2000],
['03063219257',2000],
['03078697976',2000],
['03034452449',2000],
['03356537264',2000],
['03228018593',2000],
['03376127288',2000],
['03221790139',2000],
['03121902913',2000],
['03035386524',2000],
['03287991802',2000],
['03052889270',2000],
['03278090993',2000],
['03043743245',2000],
['03360928304',2000],
['03086915740',2000],
['03074264408',2000],

            // ...
        ];

        $subscriptions = CustomerSubscription::where(function ($query) use ($pairs) {
            foreach ($pairs as $pair) {
                $query->orWhere(function ($subQuery) use ($pair) {
                    $subQuery->where('subscriber_msisdn', $pair[0])
                        ->where('transaction_amount', $pair[1]);
                });
            }
        })->get();

        //dd($subscriptions);


        foreach ($subscriptions as $subscription) {


            //dd($subscription);


            $find_sub = CustomerSubscription::find($subscription->subscription_id);

               $find_sub->policy_status = '0';
                $find_sub->update();

                Log::channel('unsub_number_log')->info('Bank Refund Msisdn 10-2025.', [
                    'Sub-Id' => $subscription->subscription_id,
                    'Redund-Msisdn-number' => $subscription->subscriber_msisdn,
                    'transaction_amount' => $subscription->transaction_amount,

                ]);

             $refundedCustomer = RefundedCustomer::create([
                 'subscription_id' => $subscription->subscription_id,
                 'unsubscription_id' => 2,
                 'transaction_id' => $subscription->cps_transaction_id,
                 'reference_id' => $subscription->referenceId,
                 'cps_response' => $subscription->cps_response_text,
                 'result_description' => $subscription->cps_response_text,
                 'result_code' => 0,
                 'refunded_by' => 'Danish2024',
                 'medium' => 'Bank Refund',
             ]);


             $CustomerUnSub = CustomerUnSubscription::create([
                'unsubscription_datetime' => now(),
                'medium' => "Bank Refund",
                'subscription_id' => $subscription->subscription_id,
                 'refunded_id' => $refundedCustomer->refund_id,
             ]);
        }


        //  dd($subscriptions);
        return 'success';

    }
}
