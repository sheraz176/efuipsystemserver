<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Models\Subscription\CustomerSubscription;
use App\Models\Unsubscription\CustomerUnSubscription;
use App\Models\Refund\RefundedCustomer;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use App\Models\logs;

class LogsSave extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'logs:save';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return int
     */
    public function handle()
    {
        DB::enableQueryLog();

         $msisdnList = [
'03016735878',
'03240655438',
'03064918426',
'03096286535',
'03006140428',
'03287799515',
'03148499009',
'03232430317',
'03075652417',
'03087976832',
'03015648561',
'03283887740',
'03097827804',
'03095453745',
'03064726339',
'03260283965',
'03079557923',
'03052085410',
'03266552341',
'03252799221',
'03288137833',
'03059232561',
'03033548330',
'03216044600',
'03043360616',
'03180457507',
'03062824237',
'03230044213',
'03455444266',
'03002740102',
'03017314116',
'03003247311',
'03140389684',
'03097408978',
'03011267435',
'03244785959',
'03271507975',
'03164720712',
'03093878295',
'03013554226',
'03007369233',
'03084360634',
'03068686034',
'03008701686',
'03006807927',
'03297577874',
'03263238437',
'03208461025',
'03063441987',
'03004373261',
'03029744321',
'03052381556',
'03093420644',
'03068078699',
'03032921319',
'03092397229',
'03029325402',
'03061478270',
'03006758530',
'03097576067',
'03014043717',
'03025182574',
'03286370556',
'03260130675',
'03036466598',
'03043812959',
'03032514212',
'03060115430',
'03211385799',
'03269351357',
'03298900074',
'03047757585',
'03046974254',
'03243231503',
'03027253087',
'03033799642',
'03252901386',
'03026818292',
'03282405477',
'03075323779',
'03284237027',
'03016937406',
'03054632413',
'03017771678',
'03006642914',
'03021569270',
'03046702714',
'03006782509',
'03045488487',
'03038115146',
'03017394893',
'03041870536',
'03286059012',
'03005270114',
'03004253434',
'03017143364',
'03069266368',
'03279178069',
'03099182650',
'03234620152',
'03068416172',
'03062910090',
'03048439478',
'03208545360',
'03009211552',
'03266385936',
'03087468201',
'03052871974',
'03059983639',
'03226941926',
'03283932067',
'03154510051',
'03083622248',
'03069229293',
'03042040970',
'03024701747',
'03038605151',
'03334668520',
'03151462188',
'03019811337',
'03074113716',
'03065404859',
'03278146397',
'03238454679',
'03001592417',
'03217040737',
'03027667329',
'03033574855',
'03228438106',
'03090017806',
'03204177306',
'03018786792',
'03014879898',
'03095421108',
'03018993248',
'03059422452',
'03013313217',
'03024765240',
'03012694798',
'03071704043',
'03033360493',
'03280619203',
'03091514880',
'03357830544',
'03027872563',
'03085554168',
'03078155440',
'03064502467',
'03035451951',
'03223416319',
'03006508513',
'03046530201',
'03003186658',
'03287373465',
'03076530070',
'03204783097',
'03075203984',
'03228708596',
'03064815715',
'03474545357',
'03091621611',
'03005658117',
'03250243383',
'03093552390',
'03058319161',
'03074162896',
'03244424206',
'03204749440',
'03279000623',
'03207982232',
'03230466717',
'03085185223',
'03228423598',
'03042839151',
'03059727953',
'03032041026',
'03206445604',
'03201027559',
'03251525798',
'03158947671',
'03061970553',
'03286203552',
'03028571793',
'03087000563',
'03056279609',
'03053295617',
'03005437316',
'03285953165',
'03332812160',
'03035550465',
'03032158148',
'03034643334',
'03288389419',
'03008108558',
'03094021016',
'03247729338',
'03039903121',
'03015260053',
'03181745151',
'03036112737',
'03045674736',
'03216589566',
'03215457315',
'03224708934',
'03103227639',
'03285910470',
'03229378355',
'03273342396',
'03027580507',
'03073825625',
'03052474897',
'03222740522',
'03102249552',
'03178484484',
'03228208563',
'03071489199',
'03200441516',
'03107802273',
'03032883825',
'03085162321',
'03017709169',
'03414321750',
'03260271640',
'03084874349',
'03259982468',
'03040072166',
'03140172978',
'03025749107',
'03012727181',
'03007333596',
'03067536742',
'03229741415',
'03065176710',
'03023182629',
'03326086403',
'03022058024',
'03284375862',
'03060020565',
'03071961453',
'03009243688',
'03127422560',
'03289896121',
'03302797371',
'03449133933',
'03246154274',
'03096839601',
'03034587368',
'03252141296',
'03049032802',
'03289641558',
'03034383833',
'03026981577',
'03237839400',
'03005658158',
'03033500963',
'03070715915',
'03099007603',
'03012040922',
'03088320272',
'03096064004',
'03044489306',
'03067400052',
'03282717578',
'03119199611',
'03037564449',
'03285002487',
'03024621499',
'03079000560',
'03015617128',
'03208424366',
'03132586773',
'03094592741',
'03191873682',
'03027272983',
'03082279692',
'03075626941',
'03338249454',
'03338697613',
'03097713733',
'03040036978',
'03013258681',
'03038551375',
'03241618479',
'03232900678',
'03045518908',
'03102460154',
'03003288423',
'03123446665',
'03233205726',
'03282280357',
'03286349478',
'03030098639',
'03089083494',
'03093837636',
'03054238380',
'03083541742',
'03073650829',
'03084246531',
'03285126743',
'03002491671',
'03287006070',
'03023961875',
'03299656599',
'03008788056',
'03289225214',
'03007961925',
'03281319381',
'03283000519',
'03296310910',
'03044052501',
'03255337298',
'03078200503',
'03261240142',
'03023648199',
'03087979855',
'03296640458',
'03219586524',
'03295095532',
'03339404712',
'03081603240',
'03040482619',
'03296904270',
'03049660567',
'03217402140',
'03017584418',
'03057320502',
'03041968522',
'03083928389',
'03007026701',
'03221147490',
'03244504911',
'03151185855',
'03024856002',
'03122467007',
'03063427206',
'03224356998',
'03007811802',
'03052070527',
'03073283258',
'03008597150',
'03041566927',
'03213632310',
'03182401312',
'03085248746',
'03000296028',
'03076648914',
'03010765248',
'03224076336',
'03053330440',
'03055811586',
'03216244546',
'03054094476',
'03028950854',
'03067716894',
'03032780474',
'03163174474',
'03076588168',
'03011638128',
'03244040223',
'03082432937',
'03096865190',
'03083603505',
'03086329176',
'03043656679',
'03016541879',
'03058411035',
'03004824310',
'03058248832',
'03004998954',
'03429392625',
'03012075873',
'03460425895',
'03286886505',
'03077531289',
'03284484374',
'03044490601',
'03057523025',
'03491203109',
'03027213313',
'03273476801',
'03078921477',
'03164025571',
'03211143461',
'03079881101',
'03046675466',
'03072705691',
'03266534765',
'03056967715',
'03064050486',
'03086437921',
'03051338934',
'03035551338',
'03076205286',
'03048488526',
'03041615759',
'03210066066',
'03086149455',
'03065738076',
'03029800493',
'03054141210',
'03052618796',
'03285397704',
'03024197777',
'03096059338',
'03275042329',
'03092885761',
'03046881456',
'03056556378',
'03064293796',
'03048645479',
'03219040037',
'03219040037',
'03219040037',
'03224975078',
'03224975078',
'03224975078',
'03090097914',
'03163385809',
'03106271993',
'03041208101',
'03236657691',
'03235126417',
'03143315715',
'03143315715',
'03143315715',
'03084961826',
'03269728475',
'03146832991',
'03146832991',
'03146832991',
'03220376609',
'03052038950',
'03253497516',
'03262978161',
'03256628068',
'03087745089',
'03087745089',
'03214675791',
'03066350574',
'03144829257',
'03135288899',
'03221007892',
'03063657826',
'03029886116',
'03254856087',
'03238163212',
'03285531190',
'03260804653',
'03353920379',
'03270656652',
'03042913831',
'03066348020',
'03235515376',
'03009027199',
'03258829229',
'03096969566',
'03017746367',
'03460023905',
'03130106456',
'03070077902',
'03016972894',
'03259938122',
'03026237156',
'03021744975',
'03193665178',
'03020001248',
'03069002567',
'03183708826',
'03014956442',
'03007274048',
'03063142768',
'03088769722',
'03002086407',
'03289503170',
'03289503170',
'03276962067',
'03009690764',
'03012228679',
'03084070280',
'03017961743',
'03011463469',
'03095306341',
'03220376609',
'03207619007',
'03074433295',
'03053146057',
'03066924366',
'03281562808',
'03037141499',
'03236147048',
'03003504415',
'03014948226',
'03056464895',
'03365158076',
'03036770994',
'03044809793',
'03130106456',
'03281743403',
'03156650648',
'03056352554',
'03281318977',
'03044970826',
'03096036267',
'03054950803',
'03055346770'
        ];


         // Get subscriptions where subscriber_msisdn matches
$subscriptions = CustomerSubscription::whereIn('subscriber_msisdn', $msisdnList)->where('policy_status',1)->get();
// dd($subscriptions);
// Convert the list of subscriptions to a collection of MSISDNs for easy comparison
$existingMsisdns = $subscriptions->pluck('subscriber_msisdn')->toArray();

foreach ($msisdnList as $msisdn) {
    // Check if the MSISDN exists in the subscriptions
    if (in_array($msisdn, $existingMsisdns)) {
        // Log the "Amount Mismatch" for existing MSISDN
        logs::create([
            'msisdn' => $msisdn,
            'resultDesc' => 'Amount Mismatch',
            'source' => 'BankRefunds',
        ]);
    } else {
        // Log "Msisdn Not Found" for MSISDNs not in the subscriptions
        logs::create([
            'msisdn' => $msisdn,
            'resultDesc' => 'Msisdn Not Found',
            'source' => 'BankRefunds',
        ]);
    }
}

$notsubscriptions = CustomerSubscription::whereIn('subscriber_msisdn', $msisdnList)->where('policy_status',0)->get();
// dd($subscriptions);
// Convert the list of subscriptions to a collection of MSISDNs for easy comparison
$existingMsisdnss = $notsubscriptions->pluck('subscriber_msisdn')->toArray();
foreach ($msisdnList as $msisdn) {
    // Check if the MSISDN exists in the subscriptions
    if (in_array($msisdn, $existingMsisdnss)) {
        // Log the "Amount Mismatch" for existing MSISDN
        logs::create([
            'msisdn' => $msisdn,
            'resultDesc' => 'Policy Already De Active',
            'source' => 'BankRefunds',
        ]);
    }
}

    //  dd($subscriptions);
        return 'success';

    }
}
